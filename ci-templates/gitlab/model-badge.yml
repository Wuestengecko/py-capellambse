# SPDX-FileCopyrightText: Copyright DB InfraGO AG
# SPDX-License-Identifier: Apache-2.0
# yaml-language-server: $schema=https://gitlab.com/gitlab-org/gitlab/-/raw/master/app/assets/javascripts/editor/schema/ci.json

generate-model-badge:
  image: python:3.13-trixie
  rules:
    - if: $CI_COMMIT_BRANCH
  script:
    - |-
      # Reset branch, to ensure we have all changes that previous pipeline jobs pushed
      if [[ -n $CI_COMMIT_BRANCH ]]; then
        git fetch --depth 1
        git reset --hard origin/$CI_COMMIT_BRANCH
      fi

    - |-
      # Install capellambse
      python -m venv /tmp/.venv
      if [[ -n "$CAPELLAMBSE_REVISION" ]]; then
        printf 'Installing capellambse version %q from Github\n' "$CAPELLAMBSE_REVISION"
        /tmp/.venv/bin/pip install "capellambse[cli] @ git+https://github.com/dbinfrago/py-capellambse.git@${CAPELLAMBSE_REVISION}"
      else
        echo "Installing latest capellambse release via pip"
        /tmp/.venv/bin/pip install "capellambse[cli]"
      fi
      source /tmp/.venv/bin/activate

    - |-
      python >"$OUTPUT_FILE" <<EOF
      import os, capellambse
      model = capellambse.loadcli(os.environ["ENTRYPOINT"])
      print(model.description_badge, end="")
      EOF

    - if [[ "${CAPELLAMBSE_PUSH_MODEL_BADGE:-1}" != 1 ]]; then exit 0; fi

    - git add "$OUTPUT_FILE"
    - "if git diff --cached --exit-code &> /dev/null; then exit 0; fi"
    - 'git commit -m "$COMMIT_MSG"'
    - git push -o ci.skip "https://${GIT_USERNAME:?}:${GIT_PASSWORD:?}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:$CI_COMMIT_BRANCH"
  artifacts:
    paths:
      - "$OUTPUT_FILE"

  variables:
    # Specify the output file
    # Defaults to model-complexity-badge.svg
    OUTPUT_FILE: model-complexity-badge.svg

    # Specify the commit message when pushing model complexity badge
    COMMIT_MSG: "docs: Add/Modify model complexity badge"

variables:
  CAPELLAMBSE_PUSH_MODEL_BADGE:
    description: Commit the model badge to git and push it back to the current branch. 1 to enable (default), 0 to disable.
    options: ["0", "1"]
    value: "1"
